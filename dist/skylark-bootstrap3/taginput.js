/**
 * skylark-bootstrap3 - The skylark standard widget tookit
 * @author Hudaokeji, Inc.
 * @version v0.9.2
 * @link https://github.com/skylarkui/skylark-bootstrap3/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-utils-dom/browser","skylark-utils-dom/eventer","skylark-utils-dom/noder","skylark-utils-dom/geom","skylark-utils-dom/query","skylark-utils-dom/plugins","./bs3"],function(t,e,i,n,a,r,o,s){"use strict";var l={tagClass:function(t){return"label label-info"},focusClass:"focus",itemValue:function(t){return t?t.toString():t},itemText:function(t){return this.itemValue(t)},itemTitle:function(t){return null},freeInput:!0,addOnBlur:!0,maxTags:void 0,maxChars:void 0,confirmKeys:[13,44],delimiter:",",delimiterRegex:null,cancelConfirmKeysOnEmpty:!1,onTagExists:function(t,e){e.hide().fadeIn()},trimValue:!1,allowDuplicates:!1,triggerChange:!0},u=s.TagsInput=o.Plugin.inherit({klassName:"TagsInput",pluginName:"bs3.TagsInput",_construct:function(e,i){this.objectItems=i&&i.itemValue,i=t.mixin({},l,r(e).data(),i),this.overrided(e,i),this.isInit=!0,this.itemsArray=[],this.$element=r(e),this.$element.hide(),this.isSelect="SELECT"===e.tagName,this.multiple=this.isSelect&&e.hasAttribute("multiple"),this.placeholderText=e.hasAttribute("placeholder")?this.$element.attr("placeholder"):"",this.inputSize=Math.max(1,this.placeholderText.length),this.$container=r('<div class="bootstrap-tagsinput"></div>'),this.$input=r('<input type="text" placeholder="'+this.placeholderText+'"/>').appendTo(this.$container),this.$element.before(this.$container),this.build(),this.isInit=!1},add:function(e,i,n){var a=this;if(!(a.options.maxTags&&a.itemsArray.length>=a.options.maxTags)&&(!1===e||e)){if("string"==typeof e&&a.options.trimValue&&(e=t.trim(e)),"object"==typeof e&&!a.objectItems)throw"Can't add objects when itemValue option is not set";if(!e.toString().match(/^\s*$/)){if(a.isSelect&&!a.multiple&&a.itemsArray.length>0&&a.remove(a.itemsArray[0]),"string"==typeof e&&"INPUT"===this.$element[0].tagName){var o=a.options.delimiterRegex?a.options.delimiterRegex:a.options.delimiter,s=e.split(o);if(s.length>1){for(var l=0;l<s.length;l++)this.add(s[l],!0);return void(i||a.pushVal(a.options.triggerChange))}}var u=a.options.itemValue(e),p=a.options.itemText(e),c=a.options.tagClass(e),h=a.options.itemTitle(e),f=t.grep(a.itemsArray,function(t){return a.options.itemValue(t)===u})[0];if(!f||a.options.allowDuplicates){if(!(a.items().toString().length+e.length+1>a.options.maxInputLength)){var d=t.Event("beforeItemAdd",{item:e,cancel:!1,options:n});if(a.$element.trigger(d),!d.cancel){a.itemsArray.push(e);var g=r('<span class="tag '+m(c)+(null!==h?'" title="'+h:"")+'">'+m(p)+'<span data-role="remove"></span></span>');g.data("item",e),a.findInputWrapper().before(g),g.after(" ");var v=r('option[value="'+encodeURIComponent(u)+'"]',a.$element).length||r('option[value="'+m(u)+'"]',a.$element).length;if(a.isSelect&&!v){var y=r("<option selected>"+m(p)+"</option>");y.data("item",e),y.attr("value",u),a.$element.append(y)}i||a.pushVal(a.options.triggerChange),a.options.maxTags!==a.itemsArray.length&&a.items().toString().length!==a.options.maxInputLength||a.$container.addClass("bootstrap-tagsinput-max"),r(".typeahead, .twitter-typeahead",a.$container).length&&a.$input.typeahead("val",""),this.isInit?a.$element.trigger(t.Event("itemAddedOnInit",{item:e,options:n})):a.$element.trigger(t.Event("itemAdded",{item:e,options:n}))}}}else if(a.options.onTagExists){var $=r(".tag",a.$container).filter(function(){return r(this).data("item")===f});a.options.onTagExists(e,$)}}}},remove:function(e,n,a){var o=this;if(o.objectItems&&(e=(e="object"==typeof e?t.grep(o.itemsArray,function(t){return o.options.itemValue(t)==o.options.itemValue(e)}):t.grep(o.itemsArray,function(t){return o.options.itemValue(t)==e}))[e.length-1]),e){var s=i.create("beforeItemRemove",{item:e,cancel:!1,options:a});if(o.$element.trigger(s),s.cancel)return;r(".tag",o.$container).filter(function(){return r(this).data("item")===e}).remove(),r("option",o.$element).filter(function(){return r(this).data("item")===e}).remove(),-1!==t.inArray(e,o.itemsArray)&&o.itemsArray.splice(t.inArray(e,o.itemsArray),1)}n||o.pushVal(o.options.triggerChange),o.options.maxTags>o.itemsArray.length&&o.$container.removeClass("bootstrap-tagsinput-max"),o.$element.trigger(i.create("itemRemoved",{item:e,options:a}))},removeAll:function(){for(r(".tag",this.$container).remove(),r("option",this.$element).remove();this.itemsArray.length>0;)this.itemsArray.pop();this.pushVal(this.options.triggerChange)},refresh:function(){var t=this;r(".tag",t.$container).each(function(){var e=r(this),i=e.data("item"),n=t.options.itemValue(i),a=t.options.itemText(i),o=t.options.tagClass(i);(e.attr("class",null),e.addClass("tag "+m(o)),e.contents().filter(function(){return 3==this.nodeType})[0].nodeValue=m(a),t.isSelect)&&r("option",t.$element).filter(function(){return r(this).data("item")===i}).attr("value",n)})},items:function(){return this.itemsArray},pushVal:function(){var e=this,i=t.map(e.items(),function(t){return e.options.itemValue(t).toString()});e.$element.val(i,!0),e.options.triggerChange&&e.$element.trigger("change")},build:function(e){var i=this;if(i.objectItems&&(i.options.freeInput=!1),p(i.options,"itemValue"),p(i.options,"itemText"),c(i.options,"tagClass"),i.options.typeahead){var n=i.options.typeahead||{};c(n,"source"),i.$input.typeahead(t.extend({},n,{source:function(e,a){function r(t){for(var e=[],n=0;n<t.length;n++){var r=i.options.itemText(t[n]);o[r]=t[n],e.push(r)}a(e)}this.map={};var o=this.map,s=n.source(e);t.isFunction(s.success)?s.success(r):t.isFunction(s.then)?s.then(r):t.Deferred.when(s).then(r)},updater:function(t){return i.add(this.map[t]),this.map[t]},matcher:function(t){return-1!==t.toLowerCase().indexOf(this.query.trim().toLowerCase())},sorter:function(t){return t.sort()},highlighter:function(t){var e=new RegExp("("+this.query+")","gi");return t.replace(e,"<strong>$1</strong>")}}))}if(i.options.typeaheadjs){var a=i.options.typeaheadjs;t.isArray(a)||(a=[null,a]),r.fn.typeahead.apply(i.$input,a).on("typeahead:selected",t.proxy(function(t,e,n){var r=0;a.some(function(t,e){return t.name===n&&(r=e,!0)}),a[r].valueKey?i.add(e[a[r].valueKey]):i.add(e),i.$input.typeahead("val","")},i))}i.$container.on("click",t.proxy(function(t){i.$element.attr("disabled")||i.$input.removeAttr("disabled"),i.$input.focus()},i)),i.options.addOnBlur&&i.options.freeInput&&i.$input.on("focusout",t.proxy(function(t){0===r(".typeahead, .twitter-typeahead",i.$container).length&&(i.add(i.$input.val()),i.$input.val(""))},i)),i.$container.on({focusin:function(){i.$container.addClass(i.options.focusClass)},focusout:function(){i.$container.removeClass(i.options.focusClass)}}),i.$container.on("keydown","input",t.proxy(function(t){var e=r(t.target),n=i.findInputWrapper();if(i.$element.attr("disabled"))i.$input.attr("disabled","disabled");else{switch(t.which){case 8:if(0===f(e[0])){var a=n.prev();a.length&&i.remove(a.data("item"))}break;case 46:if(0===f(e[0])){var o=n.next();o.length&&i.remove(o.data("item"))}break;case 37:var s=n.prev();0===e.val().length&&s[0]&&(s.before(n),e.focus());break;case 39:var l=n.next();0===e.val().length&&l[0]&&(l.after(n),e.focus())}var u=e.val().length;Math.ceil(u/5);e.attr("size",Math.max(this.inputSize,e.val().length))}},i)),i.$container.on("keypress","input",t.proxy(function(e){var n=r(e.target);if(i.$element.attr("disabled"))i.$input.attr("disabled","disabled");else{var a,o,s,l=n.val(),u=i.options.maxChars&&l.length>=i.options.maxChars;i.options.freeInput&&(a=e,o=i.options.confirmKeys,s=!1,t.each(o,function(t,e){if("number"==typeof e&&a.which===e)return s=!0,!1;if(a.which===e.which){var i=!e.hasOwnProperty("altKey")||a.altKey===e.altKey,n=!e.hasOwnProperty("shiftKey")||a.shiftKey===e.shiftKey,r=!e.hasOwnProperty("ctrlKey")||a.ctrlKey===e.ctrlKey;if(i&&n&&r)return s=!0,!1}}),s||u)&&(0!==l.length&&(i.add(u?l.substr(0,i.options.maxChars):l),n.val("")),!1===i.options.cancelConfirmKeysOnEmpty&&e.preventDefault());var p=n.val().length;Math.ceil(p/5);n.attr("size",Math.max(this.inputSize,n.val().length))}},i)),i.$container.on("click","[data-role=remove]",t.proxy(function(t){i.$element.attr("disabled")||i.remove(r(t.target).closest(".tag").data("item"))},i)),i.options.itemValue===l.itemValue&&("INPUT"===i.$element[0].tagName?i.add(i.$element.val()):r("option",i.$element).each(function(){i.add(r(this).attr("value"),!0)}))},destroy:function(){this.$container.off("keypress","input"),this.$container.off("click","[role=remove]"),this.$container.remove(),this.$element.removeData("tagsinput"),this.$element.show()},focus:function(){this.$input.focus()},input:function(){return this.$input},findInputWrapper:function(){for(var t=this.$input[0],e=this.$container[0];t&&t.parentNode!==e;)t=t.parentNode;return r(t)}});function p(t,e){if("function"!=typeof t[e]){var i=t[e];t[e]=function(t){return t[i]}}}function c(t,e){if("function"!=typeof t[e]){var i=t[e];t[e]=function(){return i}}}r.fn.tagsinput=function(t,e,i){var n=[];return this.each(function(){var a=r(this).data("tagsinput");if(a)if(t||e){if(void 0!==a[t]){if(3===a[t].length&&void 0!==i)var o=a[t](e,null,i);else o=a[t](e);void 0!==o&&n.push(o)}}else n.push(a);else a=new u(this,t),r(this).data("tagsinput",a),n.push(a),"SELECT"===this.tagName&&r("option",r(this)).attr("selected","selected"),r(this).val(r(this).val())}),"string"==typeof t?n.length>1?n:n[0]:n},r.fn.tagsinput.Constructor=u;var h=r("<div />");function m(t){return t?h.text(t).html():""}function f(t){var e=0;if(document.selection){t.focus();var i=document.selection.createRange();i.moveStart("character",-t.value.length),e=i.text.length}else(t.selectionStart||"0"==t.selectionStart)&&(e=t.selectionStart);return e}return u});
//# sourceMappingURL=sourcemaps/taginput.js.map
